name: Build and Release Plugins

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-macos-au:
    name: Build macOS AU Plugins
    runs-on: macos-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: Install Ninja
        run: brew install ninja
      
      - name: Configure CMake
        run: cmake --preset mac-fetch-dsp-release
      
      - name: Build AU Plugins
        run: cmake --build build/fetch-release --target all_plugins_AU --config Release
      
      - name: Package AU Plugins
        run: |
          ditto -c -k --sequesterRsrc --keepParent build/fetch-release/release-staging/AU JonssonicPlugins_macOS_AU.zip
      
      - name: Upload AU artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-au-plugins
          path: JonssonicPlugins_macOS_AU.zip
          if-no-files-found: error

  build-windows-vst3:
    name: Build Windows VST3 Plugins
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2
      
      - name: Configure CMake
        run: cmake --preset win-fetch-dsp-release
      
      - name: Build VST3 Plugins
        run: cmake --build build/fetch-release --target all_plugins_VST3 --config Release
      
      - name: Package VST3 Plugins
        run: |
          Compress-Archive -Path build\fetch-release\release-staging\VST3\* -DestinationPath JonssonicPlugins_Windows_VST3.zip
        shell: pwsh
      
      - name: Upload VST3 artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-vst3-plugins
          path: JonssonicPlugins_Windows_VST3.zip
          if-no-files-found: error

  release:
    name: Create Release
    needs: [build-macos-au, build-windows-vst3]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
      - name: Download macOS AU artifacts
        uses: actions/download-artifact@v4
        with:
          name: macos-au-plugins
          path: release-artifacts
      
      - name: Download Windows VST3 artifacts
        uses: actions/download-artifact@v4
        with:
          name: windows-vst3-plugins
          path: release-artifacts
      
      - name: Create release body
        run: |
          cat > release_body.md << 'EOF'
          ## Installation Instructions
          
          ### macOS (AU Plugins)
          1. Download the desired `*_AU_macOS.zip` file(s)
          2. Unzip the downloaded file(s)
          3. Copy the `.component` file(s) to one of these locations:
             - **User**: `~/Library/Audio/Plug-Ins/Components/`
             - **System**: `/Library/Audio/Plug-Ins/Components/`
          4. Restart your DAW (Digital Audio Workstation)
          5. Rescan plugins in your DAW if necessary
          6. The plugin(s) should now appear in your DAW's plugin list
          
          ### Windows (VST3 Plugins)
          1. Download the desired `*_VST3_Windows.zip` file(s)
          2. Unzip the downloaded file(s)
          3. Copy the `.vst3` folder(s) to one of these locations:
             - **64-bit**: `C:\Program Files\Common Files\VST3\`
             - **Custom**: Your DAW's custom VST3 folder (if configured)
          4. Restart your DAW
          5. Rescan plugins in your DAW if necessary
          6. The plugin(s) should now appear in your DAW's plugin list
        
          EOF
      
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: release-artifacts/*.zip
          body_path: release_body.md
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
